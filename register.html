<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./Css/bootstrap.min.css">
  <title>Best Brain - Registration</title>
  <link rel="icon" type="image/x-icon" href="favicon (1).ico">
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <script src="https://kit.fontawesome.com/64d58efce2.js" crossorigin="anonymous"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700&display=swap");

    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
      background-color: #f3f7f7;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .card {
      width: 90%;
      max-width: 350px;
      background-color: #000aba;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      border-radius: 20px;
      margin: 40px 0;
    }

    .form {
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    .form input,
    .form select {
      padding: 11px;
      margin-bottom: 8px;
      border-radius: 5px;
      border: 1px solid #003C96;
      color: #5b0101;
      width: 100%;
      font-family: "Poppins", sans-serif;
      font-size: 80%;
      font-weight: bold;
      background-color: white;
    }

    .login_btn,
    .cancel_btn {
      font-size: 18px;
      color: white;
      border-radius: 15px;
      border: none;
      background: #d31005;
      padding: 12px;
      margin-top: 12px;
      width: 100%;
      cursor: pointer;
      font-weight: bold;
      text-align: center;
    }

    #whatsappBtn {
      background: #25D366;
    }

    #smsBtn {
      background: #007AFF;
    }
  </style>
</head>

<body>
  <div class="card">
    <h4>Calculate School's Enrollments</h4>

    <!-- FORM -->
    <div class="form">
      <input type="text" id="schoolName" placeholder="School Name" required>
      <input type="text" id="contact" inputmode="numeric" placeholder="Contact" required>
      <input type="text" id="location" placeholder="Location" required>

      <select id="registrationType" onchange="showForm()">
        <option value="">Select Exam Type</option>
        <option value="terminal">Terminal</option>
        <option value="mock">Mock</option>
      </select>

      <select id="ghanaLang" style="display:none;">
        <option value="">Select Ghanaian Language</option>
        <option value="Akan (Twi/Fante)">Akan (Twi/Fante)</option>
        <option value="Ewe">Ewe</option>
        <option value="Ga">Ga</option>
        <option value="Dagbani">Dagbani</option>
        <option value="Gonja">Gonja</option>
        <option value="Nzema">Nzema</option>
      </select>

      <select id="french" style="display:none;">
        <option value="">French Offered?</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>

      <div id="terminalCandidates" style="display:none;">
        <input type="number" id="nursery" placeholder="Nursery" oninput="validateInput(this)">
        <input type="number" id="kg1" placeholder="KG 1" oninput="validateInput(this)">
        <input type="number" id="kg2" placeholder="KG 2" oninput="validateInput(this)">
        <input type="number" id="basic1" placeholder="Basic 1" inputmode="numeric" oninput="validateInput(this)">
        <input type="number" id="basic2" placeholder="Basic 2" oninput="validateInput(this)">
        <input type="number" id="basic3" placeholder="Basic 3" oninput="validateInput(this)">
        <input type="number" id="basic4" placeholder="Basic 4" oninput="validateInput(this)">
        <input type="number" id="basic5" placeholder="Basic 5" oninput="validateInput(this)">
        <input type="number" id="basic6" placeholder="Basic 6" oninput="validateInput(this)">
        <input type="number" id="basic7" placeholder="Basic 7" oninput="validateInput(this)">
        <input type="number" id="basic8" placeholder="Basic 8" oninput="validateInput(this)">
        <input type="number" id="basic9" placeholder="Basic 9" inputmode="numeric" oninput="validateInput(this)">
      </div>

      <button class="login_btn" onclick="confirmRegistration()">Register</button>
    </div>

    <!-- SUMMARY -->
    <div id="summarySection" style="display:none;">
      <h4>Summary</h4>
      <p id="summaryText"></p>
      <button class="cancel_btn" onclick="resetForm()">Cancel</button>
      <button id="whatsappBtn" class="login_btn">Send via WhatsApp</button>
      <button id="smsBtn" class="login_btn">Send via SMS</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBgS5s6SHMj4RqZwq5MxM0crT2t-XT2vbs",
  authDomain: "scanparceltoday.firebaseapp.com",
  projectId: "scanparceltoday",
  storageBucket: "scanparceltoday.firebasestorage.app",
  messagingSenderId: "537794506429",
  appId: "1:537794506429:web:17b8d24e4ec5f770a9d1d4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const fmt = new Intl.NumberFormat('en-US');


/* ---------------- HELPERS ---------------- */
function validateInput(input) {
  input.value = input.value.replace(/[^0-9]/g, '');
}

function generateSchoolCode(name) {
  return name.replace(/\s+/g, "").toUpperCase() + "-" + Math.floor(1000 + Math.random() * 9000);
}

function v(id) {
  return parseInt(document.getElementById(id).value) || 0;
}


/* ---------------- FORM SWITCHER ---------------- */
function showForm() {
  let type = document.getElementById("registrationType").value;
  let container = document.getElementById("terminalCandidates");
  let inputs = document.querySelectorAll("#terminalCandidates input");

  inputs.forEach(i => { i.value = ""; i.style.display = "block"; });

  document.getElementById("ghanaLang").style.display = type ? "block" : "none";
  document.getElementById("french").style.display = type ? "block" : "none";

  if (type === "terminal") {
    container.style.display = "block";
  }
  else if (type === "mock") {
    container.style.display = "block";
    inputs.forEach(i => i.style.display = "none");
    document.getElementById("basic9").style.display = "block";
  }
  else {
    container.style.display = "none";
  }
}


/* ---------------- MAIN SUBMISSION ---------------- */
async function confirmRegistration() {

  let schoolName = document.getElementById("schoolName").value.trim();
  let contact = document.getElementById("contact").value.trim();
  let location = document.getElementById("location").value.trim();
  let type = document.getElementById("registrationType").value;
  let lang = document.getElementById("ghanaLang").value;
  let french = document.getElementById("french").value;

  if (!contact || !location) return alert("Contact & Location required.");
  if (!type) return alert("Select exam type.");
  if (!lang) return alert("Select Ghanaian Language.");
  if (!french) return alert("Select French option.");

  let categories;

  if (type === "terminal") {
    let inputs = document.querySelectorAll("#terminalCandidates input");
    for (let i of inputs) if (i.value === "") return alert("Fill all class fields.");

    categories = {
      "Pre-School": (v("nursery") + v("kg1") + v("kg2")) * 8,
      "Lower Primary": (v("basic1") + v("basic2") + v("basic3")) * 9,
      "Upper Primary": (v("basic4") + v("basic5") + v("basic6")) * 10,
      "Basic 7-8": (v("basic7") + v("basic8")) * 15,
      "Basic 9": v("basic9") * 12
    };
  } else {
    if (document.getElementById("basic9").value === "")
      return alert("Enter Basic 9 enrollment.");
    categories = { "Mock": v("basic9") * 20 };
  }


  /* ----------- BILL ------------ */
  let totalBill = 20;
  for (let key in categories) totalBill += categories[key];


  /* ----------- SAVE SCHOOL IF NEW ------------ */
  let schoolId = localStorage.getItem("schoolId");

  if (!schoolId) {
    schoolId = generateSchoolCode(schoolName || "SCHOOL");
    localStorage.setItem("schoolId", schoolId);

    await db.collection("schools").doc(schoolId).set({
      schoolName: schoolName || "N/A",
      contact,
      location,
      language: lang,
      french,
      createdAt: new Date().toISOString()
    });
  }


  /* ----------- SAVE REGISTRATION ------------ */
  let enrollment = {
    nursery: v("nursery"),
    kg1: v("kg1"),
    kg2: v("kg2"),
    basic1: v("basic1"),
    basic2: v("basic2"),
    basic3: v("basic3"),
    basic4: v("basic4"),
    basic5: v("basic5"),
    basic6: v("basic6"),
    basic7: v("basic7"),
    basic8: v("basic8"),
    basic9: v("basic9")
  };

  await db.collection("registrations").add({
    schoolId,
    examType: type,
    enrollment,
    billAmount: totalBill,
    submittedAt: new Date().toISOString()
  });


  /* ----------- SUMMARY ------------ */
  let summary = `<b>School ID:</b> ${schoolId}<br><b>Exam Type:</b> ${type}<br><b>Language:</b> ${lang}<br><b>French:</b> ${french}<br><br>`;
  for (let key in categories) summary += `${key}: GHS ${fmt.format(categories[key])}<br>`;

  document.getElementById("summaryText").innerHTML =
    summary + `<br><b>Total Bill: GHS ${fmt.format(totalBill)}</b>`;

  document.querySelector(".form").style.display = "none";
  document.getElementById("summarySection").style.display = "block";


  /* ----------- SHARING ------------ */
  let msg = encodeURIComponent(
    `School ID: ${schoolId}
School Name: ${schoolName}
Contact: ${contact}
Location: ${location}
Exam Type: ${type}
Language: ${lang}
French: ${french}
Total Bill: GHS ${fmt.format(totalBill)}
Use School ID as payment reference.`
  );

  document.getElementById("whatsappBtn").onclick =
    () => window.open(`https://api.whatsapp.com/send?text=${msg}`);

  document.getElementById("smsBtn").onclick =
    () => window.open(`sms:?body=${msg}`);
}


/* ---------------- RESET ---------------- */
function resetForm() {
  document.querySelector(".form").style.display = "flex";
  document.getElementById("summarySection").style.display = "none";
  document.querySelectorAll("input").forEach(i => i.value = "");
  document.querySelectorAll("select").forEach(s => s.value = "");
  document.getElementById("terminalCandidates").style.display = "none";
  document.getElementById("ghanaLang").style.display = "none";
  document.getElementById("french").style.display = "none";
}
</script>

</body>
</html>
